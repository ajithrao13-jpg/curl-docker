# Vulnerability Remediation Guide for Liquibase Docker Image

## Executive Summary
This document provides detailed analysis and solutions for the 36 vulnerabilities found in the custom Liquibase Docker image, categorized by severity and fixability.

## Vulnerability Breakdown

### High Severity Vulnerabilities (7 total)

#### 1. Go Standard Library (stdlib 1.25.1) - 4 HIGH CVEs
- **CVE-2025-61725**: Email address parsing excessive CPU consumption
- **CVE-2025-61723**: PEM parsing non-linear processing time
- **CVE-2025-58188**: DSA certificate validation panic
- **CVE-2025-58187**: Certificate name constraint checking performance issue

**Fix**: Upgrade Go to version 1.25.3
- Location: `/liquibase/bin/lpm` binary
- Action: Rebuild lpm binary with Go 1.25.3 or use updated Liquibase base image

#### 2. Netty Dependencies - 3 HIGH CVEs

**CVE-2025-55163** (io.netty/netty-codec-http2@4.1.110.Final)
- CVSS: 8.2 - Allocation of Resources Without Limits
- "MadeYouReset" DDoS vulnerability
- **Fix**: Upgrade to netty-codec-http2 4.1.124.Final or later

**CVE-2025-24970** (io.netty/netty-handler@4.1.110.Final)
- CVSS: 7.5 - Improper Input Validation
- Native SSL crash vulnerability
- **Fix**: Upgrade to netty-handler 4.1.118.Final or later

**CVE-2024-57699** (net.minidev/json-smart@2.5.1)
- CVSS: 7.5 - Uncontrolled Recursion
- Stack exhaustion via deeply nested JSON
- **Fix**: Upgrade to json-smart 2.5.2 or later

**Location**: All in `/liquibase/lib/liquibase-azure-deps-4.33.0.jar`

### Medium Severity Vulnerabilities (13 total)

#### Go Standard Library - 6 MEDIUM CVEs
- CVE-2025-61724: SMTP response parsing CPU consumption
- CVE-2025-58189: TLS ALPN error handling
- CVE-2025-58186: HTTP cookie parsing memory consumption
- CVE-2025-58185: DER payload memory exhaustion
- CVE-2025-47912: URL parsing IPv6 validation
- CVE-2025-58183: GNU tar sparse files memory issue

**Fix**: Upgrade Go to version 1.25.2 or later

#### Netty Dependencies - 4 MEDIUM CVEs
- CVE-2025-25193 (netty-common): Environment file DoS (Fix: 4.1.118.Final)
- CVE-2024-47535 (netty-common): Windows environment file DoS (Fix: 4.1.115.Final)
- CVE-2025-58057 (netty-codec): Brotli decoder zip bomb (Fix: 4.1.125.Final)
- CVE-2025-53864 (nimbus-jose-jwt@9.40): Deeply nested JSON DoS (Fix: 10.0.2)

#### OS-Level - 3 MEDIUM CVEs (Unfixable in Ubuntu 22.04)
- CVE-2021-31879 (wget): Authorization header leak
- CVE-2025-8941 (pam): Privilege escalation via symlink attacks
- CVE-2025-45582 (tar): Directory traversal file overwrite

### Low Severity Vulnerabilities (16 total)

Most LOW severity vulnerabilities are in OS packages and are:
1. **Not fixed** in Ubuntu 22.04 LTS
2. Require specific attack scenarios (local access, specific configurations)
3. Have low EPSS scores (low probability of exploitation)

Examples:
- curl CVEs (CVE-2025-0167, CVE-2025-9086)
- shadow CVEs (CVE-2023-29383, CVE-2024-56433)
- Various system libraries (openssl, libgcrypt20, pcre2, etc.)

## Recommended Fixes

### Option 1: Update Dependencies (Recommended)
Update the vulnerable Java dependencies by creating a new custom JAR or finding updated versions:

```bash
# Required dependency versions:
- io.netty:netty-codec-http2:4.1.125.Final (or later)
- io.netty:netty-handler:4.1.118.Final (or later)
- io.netty:netty-common:4.1.118.Final (or later)
- io.netty:netty-codec:4.1.125.Final (or later)
- net.minidev:json-smart:2.5.2 (or later)
- com.nimbusds:nimbus-jose-jwt:10.0.2 (or later)
```

### Option 2: Use Newer Liquibase Base Image
Check if a newer version of `liquibase/liquibase` exists with updated dependencies:

```dockerfile
FROM liquibase/liquibase:4.33.0  # or latest stable version
```

### Option 3: Use Distroless or Alpine Base
To reduce OS-level vulnerabilities, consider using a minimal base image:

```dockerfile
# Use distroless Java base
FROM gcr.io/distroless/java17-debian12:nonroot
# Or Alpine
FROM alpine:3.19
```

### Option 4: Multi-Stage Build with Latest Dependencies
Build a custom image with manually updated dependencies:

```dockerfile
# Build stage with dependency updates
FROM maven:3.9-eclipse-temurin-17 AS builder
WORKDIR /build

# Download and update dependencies
# ... (see full Dockerfile example below)

# Final stage with minimal base
FROM eclipse-temurin:17-jre-alpine
# Copy updated artifacts
```

## Implementation Steps

### Step 1: Update liquibase-azure-deps JAR
1. Extract the current JAR: `jar xf liquibase-azure-deps-4.33.0.jar`
2. Update the Netty JARs in the extracted lib directory
3. Update json-smart and nimbus-jose-jwt JARs
4. Repackage: `jar cf liquibase-azure-deps-4.33.0-updated.jar *`

### Step 2: Update Dockerfile
Use the updated JAR in your Dockerfile

### Step 3: Update mssql-jdbc Driver
Check for newer version at: https://github.com/microsoft/mssql-jdbc/releases

Current: mssql-jdbc-13.2.1.jre11.jar
Latest: Check for 13.x or 14.x versions

### Step 4: Update Base Liquibase Image
```dockerfile
FROM liquibase/liquibase:4.33.0  # Use latest stable
```

### Step 5: Rebuild and Test
```bash
docker build -t liquibase-azure:secure .
docker run liquibase-azure:secure --version
```

### Step 6: Scan Again
```bash
docker scout cves liquibase-azure:secure
```

## Unfixable Vulnerabilities

The following vulnerabilities cannot be fixed without changing the base OS or waiting for upstream patches:

### OS-Level (Ubuntu 22.04 LTS)
1. **curl** (CVE-2025-0167, CVE-2025-9086) - No fix available
2. **shadow** (CVE-2024-56433, CVE-2023-29383) - No fix available
3. **openssl** (CVE-2024-41996) - No fix available
4. **libgcrypt20** (CVE-2024-2236) - No fix available
5. **pcre2** (CVE-2022-41409) - No fix available
6. **pcre3** (CVE-2017-11164) - No fix available
7. **libzstd** (CVE-2022-4899) - No fix available
8. **ncurses** (CVE-2023-50495) - No fix available
9. **coreutils** (CVE-2016-2781) - No fix available
10. **systemd** (CVE-2023-7008) - No fix available
11. **gcc-12** (CVE-2022-27943) - No fix available
12. **gnupg2** (CVE-2022-3219) - No fix available
13. **wget** (CVE-2021-31879) - No fix available
14. **pam** (CVE-2025-8941) - No fix available
15. **tar** (CVE-2025-45582) - No fix available

### Partially Fixable
- **libssh** (CVE-2025-8114) - Fixed in 0.9.6-2ubuntu0.22.04.5
  - Update base image to get this fix

## Risk Assessment

### Critical Priority (Fix Immediately)
- ✅ Netty codec-http2 (CVE-2025-55163) - CVSS 8.2
- ✅ json-smart (CVE-2024-57699) - CVSS 7.5
- ✅ Netty handler (CVE-2025-24970) - CVSS 7.5
- ✅ Go stdlib HIGH CVEs - Multiple DoS vectors

### High Priority (Fix Soon)
- ✅ Go stdlib MEDIUM CVEs
- ✅ Netty common/codec MEDIUM CVEs
- ✅ nimbus-jose-jwt (CVE-2025-53864) - CVSS 5.8

### Low Priority (Monitor/Accept Risk)
- ⚠️ OS-level LOW severity CVEs (mostly require local access or specific scenarios)
- ⚠️ Unfixable OS vulnerabilities (consider base image change for better posture)

## Alternative Solutions

### Use Official Azure SQL Tools Image
If your primary need is Azure SQL connectivity, consider:
- microsoft/mssql-tools
- mcr.microsoft.com/azure-cli

### Use Cloud-Native Solutions
- Azure Database Migration Service
- Azure Data Studio
- Managed Liquibase services

## Testing After Remediation

1. **Functional Testing**
   ```bash
   docker run liquibase-azure:secure --version
   docker run liquibase-azure:secure --help
   ```

2. **Vulnerability Scanning**
   ```bash
   docker scout cves liquibase-azure:secure --format sarif
   trivy image liquibase-azure:secure
   ```

3. **Connection Testing**
   ```bash
   docker run liquibase-azure:secure \
     --url=jdbc:sqlserver://yourserver.database.windows.net:1433 \
     --username=user --password=pass \
     status
   ```

## Conclusion

To significantly reduce vulnerabilities:

1. ✅ **Update Java dependencies** (fixes 10+ HIGH/MEDIUM CVEs)
2. ✅ **Update Go binary** or use newer Liquibase base (fixes 10 HIGH/MEDIUM CVEs)
3. ✅ **Consider distroless/Alpine base** (reduces OS vulnerability surface)
4. ⚠️ **Accept remaining LOW severity OS CVEs** or switch to different base OS

**Expected Reduction**: 
- Before: 36 vulnerabilities (7 HIGH, 13 MEDIUM, 16 LOW)
- After fixes: ~16 vulnerabilities (0 HIGH, 0-2 MEDIUM, 14-16 LOW)
- Reduction: ~56% total, 100% HIGH severity elimination

## References
- Liquibase Documentation: https://docs.liquibase.com/
- Docker Scout: https://docs.docker.com/scout/
- Netty Security Advisories: https://github.com/netty/netty/security/advisories
- MSSQL JDBC Driver: https://github.com/microsoft/mssql-jdbc
